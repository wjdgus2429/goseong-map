<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>고성 직업MAP</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100vh;
    }

    /* 상단 검색/필터 영역 전체 */
    #ui-wrapper {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-family: sans-serif;
      font-size: 14px;
      min-width: 320px;
      max-width: 520px;
    }

    /* 검색 박스 */
    #search-box {
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      gap: 6px;
      align-items: center;
    }
    #search-input {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 8px;
      min-width: 220px;
      flex: 1;
    }
    #search-button {
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      background: #4a90e2;
      color: white;
      cursor: pointer;
      white-space: nowrap;
    }
    #search-button:hover {
      background: #3577c5;
    }

    /* 산업 필터 버튼들 */
    #industry-filter {
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .industry-btn {
      border: 1px solid #ccc;
      border-radius: 16px;
      padding: 4px 10px;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .industry-btn.active {
      background: #4a90e2;
      border-color: #4a90e2;
      color: white;
      font-weight: 600;
    }

    /* ====== 마커 클릭 시 뜨는 작은 팝업(카드) ====== */
    .company-overlay {
      display: flex;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 6px 8px;
      gap: 8px;
      min-width: 210px;
      max-width: 260px;
      font-family: sans-serif;
      font-size: 12px;
    }
    .company-overlay img {
      width: 70px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }
    .company-overlay .co-name {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 2px;
    }
    .company-overlay .co-industry {
      color: #666;
      margin-bottom: 2px;
    }
    .company-overlay .co-main {
      margin-bottom: 2px;
    }
    .company-overlay .co-meta {
      color: #777;
      margin-bottom: 4px;
    }
    .company-overlay .co-more {
      border: none;
      background: #4a90e2;
      color: white;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }

    /* ====== 하단 자세히보기 패널 ====== */
    #detail-panel {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 0 12px 12px;
      box-sizing: border-box;
      z-index: 20;
    }
    #detail-panel.hidden {
      display: none;
    }
    #detail-inner {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      border-radius: 14px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.25);
      padding: 10px 14px 12px;
      font-family: sans-serif;
      font-size: 13px;
    }
    #detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    #detail-title {
      font-weight: 700;
      font-size: 14px;
    }
    #detail-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
    }
    #detail-links {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #detail-links li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    #detail-links span {
      color: #555;
    }
    #detail-links a {
      color: #4a90e2;
      text-decoration: underline;
      font-weight: 600;
    }
  </style>

  <!-- Kakao Map SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3ef40c514a8e54dbb7fdb040363526ad&autoload=false"></script>
</head>
<body>

  <!-- 상단 UI (검색 + 산업 필터) -->
  <div id="ui-wrapper">
    <!-- 기업명 검색 -->
    <div id="search-box">
      <span>기업 검색:</span>
      <input id="search-input" type="text" placeholder="기업명을 입력하세요" />
      <button id="search-button">검색</button>
    </div>

    <!-- 산업 필터 -->
    <div id="industry-filter">
      <button class="industry-btn" data-industry="">전체</button>
      <button class="industry-btn" data-industry="ship">조선·해양</button>
      <button class="industry-btn" data-industry="aero">우주·항공</button>
      <button class="industry-btn" data-industry="craft">공예·공방</button>
      <button class="industry-btn" data-industry="tradition">전통·예술</button>
      <button class="industry-btn" data-industry="agri">6차산업</button>
    </div>
  </div>

  <!-- 지도 -->
  <div id="map"></div>

  <!-- 하단 자세히보기 패널 -->
  <div id="detail-panel" class="hidden">
    <div id="detail-inner">
      <div id="detail-header">
        <div id="detail-title"></div>
        <button id="detail-close">×</button>
      </div>
      <ul id="detail-links">
        <li id="row-company">
          <span>기업주소</span>
          <a id="link-company" href="#" target="_blank">바로가기</a>
        </li>
        <li id="row-job">
          <span>직업정보</span>
          <a id="link-job" href="#" target="_blank">바로가기</a>
        </li>
        <li id="row-cert">
          <span>자격정보</span>
          <a id="link-cert" href="#" target="_blank">바로가기</a>
        </li>
      </ul>
    </div>
  </div>

  <script>
    // 1) 기업 데이터
    //  - 아래 필드들만 채워넣으면 됨
    //    industry      : 산업 코드 (ship / aero / craft / tradition / agri)
    //    industryName  : 산업명 (조선·해양 등)
    //    name          : 기업명
    //    lat, lng      : 위도, 경도
    //    mainWork      : 주요업무 (예: "항공기·우주선 개발 및 제작")
    //    size          : 기업규모 (예: "대기업", "중견기업", "중소기업")
    //    jobCategory   : 직업분류 (예: "항공·우주 엔지니어")
    //    imageUrl      : 기업 대표 이미지 전체 URL (없으면 빈 문자열 "" 로 두기)
    //    companyUrl    : 기업주소/홈페이지/지도 링크
    //    jobInfoUrl    : 직업정보(커리어넷 등) 링크
    //    certInfoUrl   : 자격정보(큐넷 등) 링크

    const companies = [
      {
        id: "kai",
        industry: "aero",
        industryName: "우주·항공",
        name: "KAI(한국항공우주산업)",
        lat: 34.9781625980645,
        lng: 128.29042206421983,
        mainWork: "",
        size: "",
        jobCategory: "",
        imageUrl: "",
        companyUrl: "",
        jobInfoUrl: "",
        certInfoUrl: ""
      },
      {
        id: "ek",
        industry: "ship",
        industryName: "조선·해양",
        name: "EK중공업",
        lat: 35.011319508463835,
        lng: 128.48268869165898,
        mainWork: "",
        size: "",
        jobCategory: "",
        imageUrl: "",
        companyUrl: "",
        jobInfoUrl: "",
        certInfoUrl: ""
      },
      {
        id: "sk-ocean",
        industry: "ship",
        industryName: "조선·해양",
        name: "SK오션플랜트",
        lat: 35.05193447409189,
        lng: 128.47723012735116,
        mainWork: "",
        size: "",
        jobCategory: "",
        imageUrl: "",
        companyUrl: "",
        jobInfoUrl: "",
        certInfoUrl: ""
      },
      {
        id: "samgang",
        industry: "ship",
        industryName: "조선·해양",
        name: "삼강S&C",
        lat: 34.99369305057122,
        lng: 128.46167095183077,
        mainWork: "",
        size: "",
        jobCategory: "",
        imageUrl: "",
        companyUrl: "",
        jobInfoUrl: "",
        certInfoUrl: ""
      },
      {
        id: "mom-hand",
        industry: "craft",
        industryName: "공예·공방",
        name: "엄마손공방",
        lat: 34.97596206764501,
        lng: 128.31615596063517,
        mainWork: "",
        size: "",
        jobCategory: "",
        imageUrl: "",
        companyUrl: "",
        jobInfoUrl: "",
        certInfoUrl: ""
      },
      {
        id: "ogwangdae",
        industry: "tradition",
        industryName: "전통·예술",
        name: "고성오광대보존회",
        lat: 34.973605070659815,
        lng: 128.33412518499514,
        mainWork: "",
        size: "",
        jobCategory: "",
        imageUrl: "",
        companyUrl: "",
        jobInfoUrl: "",
        certInfoUrl: ""
      },
      {
        id: "jungdong-farm",
        industry: "agri",
        industryName: "6차산업",
        name: "정동목장교육농장",
        lat: 35.122873160327366,
        lng: 128.26343036412558,
        mainWork: "",
        size: "",
        jobCategory: "",
        imageUrl: "",
        companyUrl: "",
        jobInfoUrl: "",
        certInfoUrl: ""
      }
    ];

    // id로 빠르게 찾기 위한 맵
    const companyById = {};
    companies.forEach(c => { companyById[c.id] = c; });

    let map;
    let currentMarkers = [];
    let currentOverlay = null;

    // 상태값: 선택된 산업 & 검색어
    let currentIndustry = "";   // "", "ship", "aero", ...
    let currentKeyword = "";    // 기업명 검색어

    window.onload = function () {
      kakao.maps.load(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const industryParam = urlParams.get("industry");
        if (industryParam) {
          currentIndustry = industryParam;
        }

        const mapContainer = document.getElementById("map");
        const mapOption = {
          center: new kakao.maps.LatLng(34.99, 128.35),
          level: 10
        };
        map = new kakao.maps.Map(mapContainer, mapOption);

        setupIndustryButtons();
        setupSearch();
        setupDetailPanel();

        // 초기 렌더링
        renderMarkers(getFilteredData());
      });
    };

    // 현재 상태(currentIndustry, currentKeyword)에 따라 데이터 필터링
    function getFilteredData() {
      let data = companies;

      if (currentIndustry) {
        data = data.filter(c => c.industry === currentIndustry);
      }

      if (currentKeyword) {
        const kw = currentKeyword.toLowerCase();
        data = data.filter(c =>
          c.name.toLowerCase().includes(kw)
        );
      }

      return data;
    }

    // 마커 그리기
    function renderMarkers(data) {
      // 기존 마커 제거
      currentMarkers.forEach(m => m.marker.setMap(null));
      currentMarkers = [];

      // 기존 팝업/자세히보기 닫기
      if (currentOverlay) {
        currentOverlay.setMap(null);
        currentOverlay = null;
      }
      closeDetailPanel();

      if (data.length === 0) return;

      data.forEach(company => {
        const position = new kakao.maps.LatLng(company.lat, company.lng);

        const marker = new kakao.maps.Marker({
          position,
          map
        });

        kakao.maps.event.addListener(marker, "click", function () {
          openCompanyOverlay(company, position);
        });

        currentMarkers.push({ marker, company });
      });

      const first = data[0];
      map.setCenter(new kakao.maps.LatLng(first.lat, first.lng));
    }

    // 마커 클릭시 뜨는 작은 팝업
    function openCompanyOverlay(company, position) {
      if (currentOverlay) {
        currentOverlay.setMap(null);
      }

      const imgSrc = company.imageUrl && company.imageUrl.trim()
        ? company.imageUrl
        : "https://via.placeholder.com/70x60?text=No+Image";

      const mainWorkText = company.mainWork || "";
      const metaText = [company.size, company.jobCategory].filter(Boolean).join(" / ");

      const content = `
        <div class="company-overlay">
          <img src="${imgSrc}" alt="${company.name}" />
          <div>
            <div class="co-name">${company.name}</div>
            <div class="co-industry">${company.industryName}</div>
            ${mainWorkText ? `<div class="co-main">${mainWorkText}</div>` : ""}
            ${metaText ? `<div class="co-meta">${metaText}</div>` : ""}
            <button class="co-more" onclick="openDetailPanel('${company.id}')">자세히보기</button>
          </div>
        </div>
      `;

      currentOverlay = new kakao.maps.CustomOverlay({
        position,
        content,
        yAnchor: 1.2
      });
      currentOverlay.setMap(map);
    }

    // 산업 버튼 세팅
    function setupIndustryButtons() {
      const buttons = document.querySelectorAll(".industry-btn");

      buttons.forEach(btn => {
        const code = btn.getAttribute("data-industry");

        // URL 파라미터로 넘어온 값에 맞춰 초기 active 지정
        if (code === currentIndustry || (currentIndustry === "" && code === "")) {
          btn.classList.add("active");
        }

        btn.addEventListener("click", function () {
          // active 표시 변경
          buttons.forEach(b => b.classList.remove("active"));
          this.classList.add("active");

          // 상태 갱신
          currentIndustry = code; // ""이면 전체

          // 필터 다시 적용
          renderMarkers(getFilteredData());
        });
      });
    }

    // 검색 세팅
    function setupSearch() {
      const input = document.getElementById("search-input");
      const button = document.getElementById("search-button");

      function doSearch() {
        currentKeyword = input.value.trim();
        renderMarkers(getFilteredData());
      }

      button.addEventListener("click", doSearch);

      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          doSearch();
        }
      });
    }

    // 자세히보기 패널 세팅
    function setupDetailPanel() {
      const closeBtn = document.getElementById("detail-close");
      closeBtn.addEventListener("click", closeDetailPanel);
    }

    function openDetailPanel(companyId) {
      const c = companyById[companyId];
      if (!c) return;

      const panel = document.getElementById("detail-panel");
      const titleEl = document.getElementById("detail-title");

      const rowCompany = document.getElementById("row-company");
      const rowJob = document.getElementById("row-job");
      const rowCert = document.getElementById("row-cert");

      const linkCompany = document.getElementById("link-company");
      const linkJob = document.getElementById("link-job");
      const linkCert = document.getElementById("link-cert");

      titleEl.textContent = c.name;

      // 각 링크 존재 여부에 따라 줄 숨김/표시
      if (c.companyUrl) {
        rowCompany.style.display = "flex";
        linkCompany.href = c.companyUrl;
      } else {
        rowCompany.style.display = "none";
      }

      if (c.jobInfoUrl) {
        rowJob.style.display = "flex";
        linkJob.href = c.jobInfoUrl;
      } else {
        rowJob.style.display = "none";
      }

      if (c.certInfoUrl) {
        rowCert.style.display = "flex";
        linkCert.href = c.certInfoUrl;
      } else {
        rowCert.style.display = "none";
      }

      panel.classList.remove("hidden");
    }

    function closeDetailPanel() {
      const panel = document.getElementById("detail-panel");
      panel.classList.add("hidden");
    }

    // 오버레이 버튼에서 쓸 수 있도록 전역에 노출
    window.openDetailPanel = openDetailPanel;
  </script>
</body>
</html>
