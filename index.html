<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>고성 직업MAP</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100vh;
    }

    /* 상단 검색/필터 영역 전체 */
    #ui-wrapper {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-family: sans-serif;
      font-size: 14px;
      min-width: 320px;
      max-width: 520px;
    }

    /* 검색 박스 */
    #search-box {
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      gap: 6px;
      align-items: center;
    }
    #search-input {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 8px;
      min-width: 220px;
      flex: 1;
    }
    #search-button {
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      background: #4a90e2;
      color: white;
      cursor: pointer;
      white-space: nowrap;
    }
    #search-button:hover {
      background: #3577c5;
    }

    /* 산업 필터 버튼들 */
    #industry-filter {
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .industry-btn {
      border: 1px solid #ccc;
      border-radius: 16px;
      padding: 4px 10px;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .industry-btn.active {
      background: #4a90e2;
      border-color: #4a90e2;
      color: white;
      font-weight: 600;
    }

    /* --------- 마커 클릭 시 뜨는 팝업(커스텀 오버레이) --------- */
    .company-overlay {
      display: flex;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 6px 8px;
      gap: 8px;
      min-width: 210px;
      max-width: 260px;
      font-family: sans-serif;
      font-size: 12px;
    }
    .company-overlay img {
      width: 70px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }
    .company-overlay .co-name {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 2px;
    }
    .company-overlay .co-industry {
      color: #666;
      margin-bottom: 2px;
    }
    .company-overlay .co-main {
      margin-bottom: 2px;
    }
    .company-overlay .co-meta {
      color: #777;
      margin-bottom: 4px;
    }
    .company-overlay .co-more {
      border: none;
      background: #4a90e2;
      color: white;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }

    /* --------- 오른쪽 자세히보기 패널 --------- */
    #detail-panel {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      z-index: 20;
    }
    #detail-panel.hidden {
      display: none;
    }
    #detail-inner {
      width: 260px;
      max-width: 90vw;
      background: white;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      padding: 10px 14px 12px;
      font-family: sans-serif;
      font-size: 13px;
    }
    #detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    #detail-title {
      font-weight: 700;
      font-size: 14px;
    }
    #detail-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      line-height: 1;
    }
    #detail-links {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #detail-links li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    #detail-links span {
      color: #555;
    }
    #detail-links a {
      color: #4a90e2;
      text-decoration: underline;
      font-weight: 600;
    }

    /* 화면이 아주 좁을 때(모바일)에는 아래쪽 패널로 내려주기 */
    @media (max-width: 600px) {
      #detail-panel {
        top: auto;
        right: 0;
        left: 0;
        bottom: 0;
        transform: none;
        padding: 0 12px 12px;
      }
      #detail-inner {
        margin: 0 auto;
        width: 100%;
        max-width: 480px;
      }
    }
  </style>

  <!-- Kakao Map SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3ef40c514a8e54dbb7fdb040363526ad&autoload=false"></script>
</head>
<body>

  <!-- 상단 UI (검색 + 산업 필터) -->
  <div id="ui-wrapper">
    <!-- 기업명 검색 -->
    <div id="search-box">
      <span>기업 검색:</span>
      <input id="search-input" type="text" placeholder="기업명을 입력하세요" />
      <button id="search-button">검색</button>
    </div>

    <!-- 산업 필터 -->
    <div id="industry-filter">
      <button class="industry-btn" data-industry="">전체</button>
      <button class="industry-btn" data-industry="ship">조선·해양</button>
      <button class="industry-btn" data-industry="aero">우주·항공</button>
      <button class="industry-btn" data-industry="craft">공예·공방</button>
      <button class="industry-btn" data-industry="tradition">전통·예술</button>
      <button class="industry-btn" data-industry="agri">6차산업</button>
    </div>
  </div>

  <!-- 지도 -->
  <div id="map"></div>

  <!-- 자세히보기 패널 -->
  <div id="detail-panel" class="hidden">
    <div id="detail-inner">
      <div id="detail-header">
        <div id="detail-title"></div>
        <button id="detail-close">×</button>
      </div>
      <ul id="detail-links">
        <li id="row-company">
          <span>기업주소</span>
          <a id="link-company" href="#" target="_blank">바로가기</a>
        </li>
        <li id="row-job">
          <span>직업정보</span>
          <a id="link-job" href="#" target="_blank">바로가기</a>
        </li>
        <li id="row-cert">
          <span>자격정보</span>
          <a id="link-cert" href="#" target="_blank">바로가기</a>
        </li>
      </ul>
    </div>
  </div>

  <script>
    /* =========================
       1. 기업 데이터
       ========================= */
    const companies = [
      {
        id: "kai",
        industry: "aero",
        industryName: "우주·항공",
        name: "KAI(한국항공우주산업)",
        lat: 34.9781625980645,
        lng: 128.29042206421983,
        mainWork: "항공기 및 발사체 조제, 관리, 생산, 개발, 연구",
        size: "국가산업(공기업)",
        jobCategory: "우주ㆍ항공 관련직",
        imageUrl: "카이.jpg",
        companyUrl: "https://www.koreaaero.com/KO/",
        jobInfoUrl: "https://www.career.go.kr/cloud/w/search/intro?text=%ED%95%AD%EA%B3%B5",
        certInfoUrl: "https://www.q-net.or.kr/totalSearch.do?gSite=Q&totalQuery=%ED%95%AD%EA%B3%B5"
      },
      {
        id: "ek",
        industry: "ship",
        industryName: "조선·해양",
        name: "EK중공업",
        lat: 35.011319508463835,
        lng: 128.48268869165898,
        mainWork: "해양 플랜트 제작, 조선 사업",
        size: "중소기업",
        jobCategory: "해양ㆍ조선 관련직",
        imageUrl: "EK중공업.jpg",
        companyUrl: "http://www.ekhi.co.kr/wp/",
        jobInfoUrl: "https://www.career.go.kr/cloud/w/job/list",
        certInfoUrl: "https://www.q-net.or.kr/totalSearch.do?gSite=Q&totalQuery=%EC%A1%B0%EC%84%A0"
      },
      {
        id: "sk-ocean",
        industry: "ship",
        industryName: "조선·해양",
        name: "SK오션플랜트",
        lat: 35.05193447409189,
        lng: 128.47723012735116,
        mainWork: "해양 에너지 관리, 해양 플랜트 하부 제작",
        size: "대기업",
        jobCategory: "해양ㆍ조선 관련직",
        imageUrl: "SK오션플랜트.jpg",
        companyUrl: "https://www.skoceanplant.com/",
        jobInfoUrl: "https://www.career.go.kr/cloud/w/job/list",
        certInfoUrl: "https://www.q-net.or.kr/totalSearch.do?gSite=Q&totalQuery=%EC%A1%B0%EC%84%A0"
      },
      {
        id: "samgang",
        industry: "ship",
        industryName: "조선·해양",
        name: "삼강S&C",
        lat: 34.99369305057122,
        lng: 128.46167095183077,
        mainWork: "신조선, 해양 플랜트 제작(수입)",
        size: "중견기업",
        jobCategory: "해양ㆍ조선 관련직",
        imageUrl: "삼강S&C.png",
        companyUrl: "https://www.sam-kang.com/snc/",
        jobInfoUrl: "https://www.career.go.kr/cloud/w/job/list",
        certInfoUrl: "https://www.q-net.or.kr/totalSearch.do?gSite=Q&totalQuery=%EC%A1%B0%EC%84%A0"
      },
      {
        id: "mom-hand",
        industry: "craft",
        industryName: "공예·공방",
        name: "엄마손공방",
        lat: 34.97596206764501,
        lng: 128.31615596063517,
        mainWork: "공예 수업, 작품 제작",
        size: "개인사업장",
        jobCategory: "자개공예, 민화체험",
        imageUrl: "엄마손공방.png",
        companyUrl: "https://www.instagram.com/umma_son_gongbang/",
        jobInfoUrl: "https://www.career.go.kr/cloud/w/major/uList",
        certInfoUrl: "https://www.q-net.or.kr/totalSearch.do?gSite=Q&totalQuery=%EA%B3%B5%EC%98%88"
      },
      {
        id: "ogwangdae",
        industry: "tradition",
        industryName: "전통·예술",
        name: "고성오광대보존회",
        lat: 34.973605070659815,
        lng: 128.33412518499514,
        mainWork: "문화제 전수 지도, 공연",
        size: "국가산업",
        jobCategory: "민속놀이, 무형문화제",
        imageUrl: "고성오광대.png",
        companyUrl: "http://www.ogwangdae.or.kr",
        jobInfoUrl: "https://www.work.go.kr/consltJobCarpa/srch/expThemeDetail.do?abnJobdptLrclId=D008&abnJobdptSmclId=10011&jobClcd=D",
        certInfoUrl: "https://www.work.go.kr/consltJobCarpa/srch/expThemeDetail.do?abnJobdptLrclId=D008&abnJobdptSmclId=10011&jobClcd=D"
      },
      {
        id: "jungdong-farm",
        industry: "agri",
        industryName: "6차산업",
        name: "정동목장교육농장",
        lat: 35.122873160327366,
        lng: 128.26343036412558,
        mainWork: "농축산업, 유제품 제조, 농장체험",
        size: "개인사업장",
        jobCategory: "축산업, 유통업, 관광산업",
        imageUrl: "정동목장.jpg",
        companyUrl: "https://www.nongsaro.go.kr/portal/ps/psz/psza/contentSub.ps?menuId=PS03965&cntntsNo=208372",
        jobInfoUrl: "https://www.career.go.kr/cloud/w/job/view?seq=174",
        certInfoUrl: "https://www.q-net.or.kr/totalSearch.do?gSite=Q&totalQuery=%EC%B6%95%EC%82%B0"
      }
    ];

    // id → company 빠르게 찾기용
    const companyById = {};
    companies.forEach(c => { companyById[c.id] = c; });

    let map;
    let currentMarkers = [];
    let currentOverlay = null;     // 마커 위 팝업
    let currentIndustry = "";      // "", "ship", "aero", ...
    let currentKeyword = "";       // 기업명 검색어

    window.onload = function () {
      kakao.maps.load(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const industryParam = urlParams.get("industry");
        if (industryParam) {
          currentIndustry = industryParam;
        }

        const mapContainer = document.getElementById("map");
        const mapOption = {
          center: new kakao.maps.LatLng(34.99, 128.35),
          level: 10
        };
        map = new kakao.maps.Map(mapContainer, mapOption);

        setupIndustryButtons();
        setupSearch();
        setupDetailPanel();

        // 지도 빈 곳 클릭 시 팝업/패널 닫기
        kakao.maps.event.addListener(map, "click", function () {
          if (currentOverlay) {
            currentOverlay.setMap(null);
            currentOverlay = null;
          }
          closeDetailPanel();
        });

        // 초기 렌더링
        renderMarkers(getFilteredData());
      });
    };

    /* =========================
       2. 필터링 & 마커 렌더링
       ========================= */
    function getFilteredData() {
      let data = companies;

      if (currentIndustry) {
        data = data.filter(c => c.industry === currentIndustry);
      }

      if (currentKeyword) {
        const kw = currentKeyword.toLowerCase();
        data = data.filter(c =>
          c.name.toLowerCase().includes(kw)
        );
      }

      return data;
    }

    function renderMarkers(data) {
      // 기존 마커 제거
      currentMarkers.forEach(m => m.marker.setMap(null));
      currentMarkers = [];

      // 기존 오버레이/자세히보기 닫기
      if (currentOverlay) {
        currentOverlay.setMap(null);
        currentOverlay = null;
      }
      closeDetailPanel();

      if (data.length === 0) return;

      data.forEach(company => {
        const position = new kakao.maps.LatLng(company.lat, company.lng);

        const marker = new kakao.maps.Marker({
          position,
          map
        });

        kakao.maps.event.addListener(marker, "click", function () {
          openCompanyOverlay(company, position);
        });

        currentMarkers.push({ marker, company });
      });

      const first = data[0];
      map.setCenter(new kakao.maps.LatLng(first.lat, first.lng));
    }

    /* =========================
       3. 마커 팝업(커스텀 오버레이)
       ========================= */
    function openCompanyOverlay(company, position) {
      if (currentOverlay) {
        currentOverlay.setMap(null);
      }

      const imgSrc = company.imageUrl && company.imageUrl.trim()
        ? encodeURI(company.imageUrl)   // 한글/특수문자 파일명 대응
        : "https://via.placeholder.com/70x60?text=No+Image";

      const mainWorkText = company.mainWork || "";
      const metaText = [company.size, company.jobCategory].filter(Boolean).join(" / ");

      const content = `
        <div class="company-overlay">
          <img src="${imgSrc}" alt="${company.name}" />
          <div>
            <div class="co-name">${company.name}</div>
            <div class="co-industry">${company.industryName}</div>
            ${mainWorkText ? `<div class="co-main">${mainWorkText}</div>` : ""}
            ${metaText ? `<div class="co-meta">${metaText}</div>` : ""}
            <button class="co-more" onclick="openDetailPanel('${company.id}')">
              자세히보기
            </button>
          </div>
        </div>
      `;

      currentOverlay = new kakao.maps.CustomOverlay({
        position,
        content,
        yAnchor: 1.2
      });
      currentOverlay.setMap(map);
    }

    /* =========================
       4. 상단 버튼 & 검색
       ========================= */
    function setupIndustryButtons() {
      const buttons = document.querySelectorAll(".industry-btn");

      buttons.forEach(btn => {
        const code = btn.getAttribute("data-industry");

        // URL 파라미터로 넘어온 값에 맞춰 초기 active 지정
        if (code === currentIndustry || (currentIndustry === "" && code === "")) {
          btn.classList.add("active");
        }

        btn.addEventListener("click", function () {
          // active 표시 변경
          buttons.forEach(b => b.classList.remove("active"));
          this.classList.add("active");

          // 상태 갱신
          currentIndustry = code; // ""이면 전체

          // 필터 다시 적용
          renderMarkers(getFilteredData());
        });
      });
    }

    function setupSearch() {
      const input = document.getElementById("search-input");
      const button = document.getElementById("search-button");

      function doSearch() {
        currentKeyword = input.value.trim();
        renderMarkers(getFilteredData());
      }

      button.addEventListener("click", doSearch);

      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          doSearch();
        }
      });
    }

    /* =========================
       5. 자세히보기 패널
       ========================= */
    function setupDetailPanel() {
      const closeBtn = document.getElementById("detail-close");
      closeBtn.addEventListener("click", closeDetailPanel);
    }

    function openDetailPanel(companyId) {
      const c = companyById[companyId];
      if (!c) return;

      const panel = document.getElementById("detail-panel");
      const titleEl = document.getElementById("detail-title");

      const rowCompany = document.getElementById("row-company");
      const rowJob = document.getElementById("row-job");
      const rowCert = document.getElementById("row-cert");

      const linkCompany = document.getElementById("link-company");
      const linkJob = document.getElementById("link-job");
      const linkCert = document.getElementById("link-cert");

      titleEl.textContent = c.name;

      if (c.companyUrl) {
        rowCompany.style.display = "flex";
        linkCompany.href = c.companyUrl;
      } else {
        rowCompany.style.display = "none";
      }

      if (c.jobInfoUrl) {
        rowJob.style.display = "flex";
        linkJob.href = c.jobInfoUrl;
      } else {
        rowJob.style.display = "none";
      }

      if (c.certInfoUrl) {
        rowCert.style.display = "flex";
        linkCert.href = c.certInfoUrl;
      } else {
        rowCert.style.display = "none";
      }

      panel.classList.remove("hidden");
    }

    function closeDetailPanel() {
      const panel = document.getElementById("detail-panel");
      panel.classList.add("hidden");
    }

    // 팝업 HTML에서 쓸 수 있도록 전역 노출
    window.openDetailPanel = openDetailPanel;
  </script>
</body>
</html>
